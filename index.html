<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Wind Farm - Multiplayer & Speed Tiebreaker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { 
            margin: 0; overflow: hidden; 
            font-family: 'Sarabun', sans-serif; 
            background-color: #e2e8f0; 
            color: #334155;
        }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(241, 245, 249, 0.95); backdrop-filter: blur(8px);
            z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .card {
            background: #ffffff; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center;
            width: 100%; max-width: 420px;
        }
        h2 { margin: 0 0 20px 0; font-size: 24px; color: #0f172a; font-weight: 700; }
        p { margin: 0 0 15px 0; font-size: 15px; color: #64748b; }
        
        input[type="text"], input[type="number"] {
            width: 100%; box-sizing: border-box; padding: 14px 20px; margin-bottom: 15px;
            border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px;
            font-family: 'Sarabun', sans-serif; transition: all 0.3s ease; outline: none; background: #f8fafc;
        }
        input:focus { border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        button {
            width: 100%; padding: 14px 20px; margin-bottom: 10px; border: none;
            border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; font-family: 'Sarabun', sans-serif;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-2px); }
        .btn-outline { background: white; color: #3b82f6; border: 2px solid #3b82f6; }
        .btn-outline:hover { background: #eff6ff; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        button:disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; transform: none; border: none; }
        .divider { display: flex; align-items: center; text-align: center; margin: 15px 0; color: #cbd5e1; font-size: 14px; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #e2e8f0; }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }
        #game-ui { display: none; }
        .game-panel {
            position: absolute; background: rgba(255, 255, 255, 0.95);
            padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            pointer-events: none; backdrop-filter: blur(5px);
        }
        #top-left-panel { top: 20px; left: 20px; width: 320px; z-index: 10; pointer-events: auto; } /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ */
        #top-right-panel { top: 20px; right: 20px; text-align: center; z-index: 10; min-width: 160px; }
        
        .highlight-text { color: #3b82f6; font-weight: 700; font-size: 18px; }
        .score-value { font-size: 36px; font-weight: 700; color: #10b981; margin: 5px 0; }
        .time-value { font-size: 20px; font-weight: 600; color: #f59e0b; margin-top: 10px; border-top: 1px solid #e2e8f0; padding-top: 10px;}
        
        .info-box { margin-top: 15px; padding: 15px; background: #f0fdf4; border-radius: 12px; display: none; border: 1px solid #bbf7d0; }
        
        #warning-msg {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 12px 24px; border-radius: 30px;
            font-weight: 600; display: none; z-index: 20; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); pointer-events: none;
        }
        #submit-btn-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10; display: none; width: 250px; pointer-events: auto;
        }
        .lb-container { max-height: 350px; overflow-y: auto; text-align: left; margin: 20px 0; padding-right: 5px; }
        .lb-container::-webkit-scrollbar { width: 6px; }
        .lb-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .rank-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; margin-bottom: 8px; background: #f8fafc;
            border-radius: 10px; font-weight: 600; transition: transform 0.2s;
        }
        .rank-1 { background: #fef3c7; border-left: 4px solid #f59e0b; color: #b45309; transform: scale(1.02); }
        .rank-2 { background: #f1f5f9; border-left: 4px solid #94a3b8; color: #475569; }
        .rank-3 { background: #ffedd5; border-left: 4px solid #fdba74; color: #c2410c; }
        .rank-me { border: 2px solid #3b82f6; background: #eff6ff; }
        
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="login-screen" class="screen">
        <div class="card">
            <h2>üå¨Ô∏è Wind Farm</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <input type="text" id="player-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." maxlength="12">
            <button class="btn-primary" onclick="goToLobby()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>
    <div id="lobby-screen" class="screen" style="display: none;">
        <div class="card">
            <h2>üéÆ ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</h2>
            <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <span id="lobby-name" class="highlight-text"></span></p>
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                <label style="display: block; text-align: left; font-size: 14px; font-weight: 600; margin-bottom: 5px; color: #475569;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (Host)</label>
                <input type="number" id="host-max-players" min="2" max="30" value="30" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (2-30)">
                <button class="btn-primary" style="margin-bottom: 0;" onclick="createRoom()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div class="divider">‡∏´‡∏£‡∏∑‡∏≠</div>
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                <label style="display: block; text-align: left; font-size: 14px; font-weight: 600; margin-bottom: 5px; color: #475569;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á (Guest)</label>
                <input type="text" id="join-code" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 4 ‡∏´‡∏•‡∏±‡∏Å..." maxlength="4">
                <button class="btn-outline" style="margin-bottom: 0;" onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
            </div>
        </div>
    </div>
    <div id="pregame-screen" class="screen" style="display: none;">
        <div class="card">
            <div class="loader"></div>
            <h2>‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: <span id="display-room-code" style="color: #3b82f6; letter-spacing: 2px;"></span></h2>
            <p id="role-status"></p>
            
            <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #64748b;">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
                <div style="font-size: 32px; font-weight: 700; color: #0f172a;">
                    <span id="players-joined">1</span><span style="font-size: 18px; color: #94a3b8;">/<span id="display-max-players">30</span></span>
                </div>
                <div style="width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden;">
                    <div id="progress-bar" style="width: 0%; background: #3b82f6; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>
            <button id="start-game-btn" class="btn-success" style="display: none;" disabled onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
            <p id="waiting-host-text" style="display: none; color: #f59e0b; font-weight: 600;">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</p>
        </div>
    </div>
    <div id="postgame-screen" class="screen" style="display: none;">
        <div class="card">
            <div class="loader"></div>
            <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...</h2>
            <p>‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ß‡∏≤‡∏á‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏•‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à</p>
            <div style="font-size: 24px; font-weight: 700; color: #3b82f6; margin-top: 10px;">
                <span id="players-finished">1</span>/<span id="display-max-players-post">30</span>
            </div>
        </div>
    </div>
    <div id="leaderboard-screen" class="screen" style="display: none;">
        <div class="card" style="max-width: 500px;">
            <h2>üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
            <p>‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏à‡∏≤‡∏Å <b>"‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°"</b> ‡∏´‡∏≤‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏π <b>"‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"</b></p>
            <div class="lb-container" id="leaderboard-list">
                </div>
            <button class="btn-primary" style="margin-top: 20px;" onclick="location.reload()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
    </div>
    <div id="game-ui">
        <div class="game-panel" id="top-left-panel">
            <h1 style="font-size: 18px; margin: 0 0 5px 0;">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="in-game-name" style="color: #3b82f6;"></span></h1>
            <p style="margin:0 0 10px 0; font-size: 13px;">‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏•‡∏°: <span id="turbines-left" class="highlight-text">3</span> / 3 ‡∏ï‡πâ‡∏ô</p>
            
            <div style="margin-top: 10px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                <button id="toggle-mode-btn" class="btn-outline" style="padding: 10px 12px; font-size: 14px; margin: 0; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05);" onclick="toggleBuildMode()">
                    üëâ ‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡πâ‡∏ô
                </button>
            </div>
            
            <div id="knowledge-box" class="info-box">
                <strong style="color: #0f172a;" id="k-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong><br>
                <span style="font-size: 13px;" id="k-desc"></span><br>
                <div style="margin-top: 8px; color:#059669; font-weight: 600;">‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï: <span id="k-power"></span> ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡∏ß‡∏¥</div>
            </div>
            
            <div style="margin-top: 15px; font-size: 12px; color: #64748b; line-height: 1.6;">
                üëÜ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á | ‚ùå ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö<br>‚ö†Ô∏è ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏≤‡∏á‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
            </div>
        </div>
        <div class="game-panel" id="top-right-panel">
            <div style="font-size: 13px; color: #64748b; font-weight: 600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div id="energy-rate" class="score-value">0</div>
            <div style="font-size: 12px; color: #94a3b8;">‡∏´‡∏ô‡πà‡∏ß‡∏¢ / ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
            
            <div class="time-value">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤: <span id="timer-display">0.00</span> ‡∏ß‡∏¥</div>
        </div>
        <div id="warning-msg">‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ!</div>
        <div id="submit-btn-container">
            <button class="btn-success" style="padding: 18px; font-size: 18px; border-radius: 30px; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);" onclick="submitScore()">‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
    </div>
    <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; pointer-events:none; background: #87CEEB;"></div>
    <script>
        // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ---
        let playerName = "";
        let roomCode = "";
        let isHost = false;
        let playersInRoom = 1;
        let maxPlayers = 30;
        let pregameInterval;
        let isGameActive = false;
        let maxTurbines = 3;
        let turbinesPlaced = 0;
        let currentEnergyRate = 0;
        const MIN_DISTANCE = 12;

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ 3 ‡∏ï‡πâ‡∏ô)
        let buildMode = "single"; 

        // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (Tiebreaker) ---
        let startTime;
        let timeTaken = 0;
        let timerInterval;

        // --- ‡∏£‡∏∞‡∏ö‡∏ö UI Flow ---
        function goToLobby() {
            const nameInput = document.getElementById('player-name').value;
            if (nameInput.trim() === "") { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!"); return; }
            playerName = nameInput;
            document.getElementById('lobby-name').innerText = playerName;
            document.getElementById('in-game-name').innerText = playerName;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
        }
        function createRoom() {
            isHost = true;
            let setMax = parseInt(document.getElementById('host-max-players').value);
            if(isNaN(setMax) || setMax < 2 || setMax > 30) setMax = 30;
            maxPlayers = setMax;
            roomCode = Math.floor(1000 + Math.random() * 9000).toString();
            setupPregameRoom();
        }
        function joinRoom() {
            const codeInput = document.getElementById('join-code').value;
            if (codeInput.length !== 4) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 4 ‡∏´‡∏•‡∏±‡∏Å!"); return; }
            isHost = false;
            roomCode = codeInput;
            maxPlayers = Math.floor(Math.random() * (30 - 10 + 1)) + 10;
            setupPregameRoom();
        }
        function setupPregameRoom() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('pregame-screen').style.display = 'flex';
            document.getElementById('display-room-code').innerText = roomCode;
            document.getElementById('display-max-players').innerText = maxPlayers;
            document.getElementById('display-max-players-post').innerText = maxPlayers;
            
            if (isHost) {
                document.getElementById('role-status').innerText = "üëë ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏´‡πâ‡∏≠‡∏á (Host)";
                document.getElementById('start-game-btn').style.display = 'block';
            } else {
                document.getElementById('role-status').innerText = "üë§ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (Guest)";
                document.getElementById('waiting-host-text').style.display = 'block';
            }
            playersInRoom = 1;
            updatePregameUI();
            
            pregameInterval = setInterval(() => {
                if (playersInRoom < maxPlayers) {
                    playersInRoom += Math.floor(Math.random() * 2) + 1;
                    if (playersInRoom > maxPlayers) playersInRoom = maxPlayers;
                    updatePregameUI();
                } else {
                    clearInterval(pregameInterval);
                    if (isHost) {
                        const startBtn = document.getElementById('start-game-btn');
                        startBtn.disabled = false;
                        startBtn.innerText = "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢!";
                    } else {
                        setTimeout(startGame, 2000);
                    }
                }
            }, 600);
        }
        function updatePregameUI() {
            document.getElementById('players-joined').innerText = playersInRoom;
            document.getElementById('progress-bar').style.width = (playersInRoom / maxPlayers * 100) + '%';
        }
        function startGame() {
            clearInterval(pregameInterval);
            document.getElementById('pregame-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('canvas-container').style.pointerEvents = 'auto'; 
            isGameActive = true;
            
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('timer-display').innerText = elapsed.toFixed(2);
            }, 50);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á
        function toggleBuildMode() {
            const btn = document.getElementById('toggle-mode-btn');
            if (buildMode === "single") {
                buildMode = "cluster";
                btn.innerText = "‚ö° ‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß 3 ‡∏ï‡πâ‡∏ô";
                btn.classList.replace('btn-outline', 'btn-primary');
            } else {
                buildMode = "single";
                btn.innerText = "üëâ ‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡πâ‡∏ô";
                btn.classList.replace('btn-primary', 'btn-outline');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showWarning(text) {
            const warn = document.getElementById('warning-msg');
            warn.innerText = text;
            warn.style.display = 'block';
            setTimeout(() => warn.style.display = 'none', 2000);
        }

        function submitScore() {
            clearInterval(timerInterval);
            timeTaken = (Date.now() - startTime) / 1000;
            
            isGameActive = false;
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('canvas-container').style.pointerEvents = 'none';
            document.getElementById('postgame-screen').style.display = 'flex';
            let finishedCount = 1;
            const postInterval = setInterval(() => {
                finishedCount += Math.floor(Math.random() * 3) + 1;
                if (finishedCount >= maxPlayers) {
                    finishedCount = maxPlayers;
                    clearInterval(postInterval);
                    setTimeout(generateLeaderboard, 500);
                }
                document.getElementById('players-finished').innerText = finishedCount;
            }, 500);
        }
        function generateLeaderboard() {
            document.getElementById('postgame-screen').style.display = 'none';
            document.getElementById('leaderboard-screen').style.display = 'flex';
            let playersData = [{ name: playerName + " (‡∏Ñ‡∏∏‡∏ì)", score: currentEnergyRate, time: timeTaken, isMe: true }];
            const botNames = ["‡∏™‡∏°‡∏´‡∏°‡∏≤‡∏¢", "‡∏ß‡∏¥‡∏†‡∏≤", "‡∏°‡∏≤‡∏ô‡∏û", "‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏£", "‡πÄ‡∏à‡∏°‡∏™‡πå", "‡∏ì‡πÄ‡∏î‡∏ä‡∏ô‡πå", "‡∏ç‡∏≤‡∏ç‡πà‡∏≤", "‡∏ö‡∏≠‡∏¢", "‡∏õ‡πâ‡∏≠‡∏°", "‡∏ô‡∏∏‡πà‡∏ô", "‡∏û‡∏•‡∏≠‡∏¢", "‡∏Å‡πâ‡∏≠‡∏á", "‡∏´‡∏ô‡∏∏‡πà‡∏°", "‡∏ü‡πâ‡∏≤", "‡∏ö‡∏¥‡πä‡∏Å", "‡∏ô‡∏±‡∏ó", "‡πÅ‡∏û‡∏£", "‡∏ï‡∏±‡πâ‡∏°", "‡πÄ‡∏≠‡∏Å", "‡πÄ‡∏Å‡πà‡∏á", "‡∏ô‡πâ‡∏≥", "‡∏°‡∏∏‡∏Å", "‡πÑ‡∏≠‡∏ã‡πå", "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", "‡∏≠‡∏≠‡∏ü", "‡∏õ‡∏π", "‡∏û‡∏¥‡∏°", "‡∏Å‡∏≤‡∏¢", "‡∏ù‡πâ‡∏≤‡∏¢"];
            
            for(let i=0; i < maxPlayers - 1; i++) {
                let botScore = Math.random() > 0.7 ? 36 : Math.floor(Math.random() * 26) + 10;
                let botTime = (Math.random() * 20) + 5;
                playersData.push({ name: botNames[i % botNames.length], score: botScore, time: botTime, isMe: false });
            }
            playersData.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                else return a.time - b.time;
            });
            const listDiv = document.getElementById('leaderboard-list');
            listDiv.innerHTML = "";
            
            playersData.forEach((p, index) => {
                let rankClass = "";
                let medal = `${index + 1}. `;
                
                if (index === 0) { rankClass = "rank-1"; medal = "ü•á "; }
                else if (index === 1) { rankClass = "rank-2"; medal = "ü•à "; }
                else if (index === 2) { rankClass = "rank-3"; medal = "ü•â "; }
                
                if (p.isMe) rankClass += " rank-me";
                listDiv.innerHTML += `
                    <div class="rank-row ${rankClass}">
                        <span style="flex:1;">${medal}${p.name}</span>
                        <div style="text-align: right;">
                            <div style="color: #10b981; font-weight: 700;">${p.score} <span style="font-size: 11px; font-weight: normal;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</span></div>
                            <div style="font-size: 12px; color: #64748b;">${p.time.toFixed(2)} ‡∏ß‡∏¥</div>
                        </div>
                    </div>
                `;
            });
        }

        // ==========================================
        // --- ‡∏£‡∏∞‡∏ö‡∏ö 3D (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° 100%) ---
        // ==========================================
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.006);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 100, 120);
        camera.lookAt(0, -10, 0);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);
       
const terrains = [];

        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏â‡∏≤‡∏Å ---
        const woodMat = new THREE.MeshStandardMaterial({ color: 0x5D4037, flatShading: true, roughness: 1 });
        const leafMat = new THREE.MeshStandardMaterial({ color: 0x2d6a4f, flatShading: true, roughness: 1 });
        const bushMat = new THREE.MeshStandardMaterial({ color: 0x43aa8b, flatShading: true, roughness: 1 });
        const rockMat = new THREE.MeshStandardMaterial({ color: 0x7f8c8d, flatShading: true, roughness: 1 });

        function createTree(x, y, z, scale) {
            const tree = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.6, 2, 6), woodMat);
            trunk.position.y = 1; trunk.castShadow = true;
            const l1 = new THREE.Mesh(new THREE.ConeGeometry(2.5, 3.5, 6), leafMat); l1.position.y = 2.5; l1.castShadow = true;
            const l2 = new THREE.Mesh(new THREE.ConeGeometry(2.0, 3.0, 6), leafMat); l2.position.y = 4.0; l2.castShadow = true;
            const l3 = new THREE.Mesh(new THREE.ConeGeometry(1.5, 2.5, 6), leafMat); l3.position.y = 5.5; l3.castShadow = true;
            tree.add(trunk, l1, l2, l3);
            tree.position.set(x, y, z); tree.scale.set(scale, scale, scale);
            return tree;
        }

        function createBush(x, y, z, scale) {
            const bush = new THREE.Mesh(new THREE.IcosahedronGeometry(1, 1), bushMat);
            bush.position.set(x, y, z); bush.scale.set(scale, scale*0.7, scale);
            bush.castShadow = true; return bush;
        }

        function createRock(x, y, z, scale) {
            const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(1, 0), rockMat);
            rock.position.set(x, y, z); rock.scale.set(scale, scale*0.8, scale*1.2);
            rock.castShadow = true; return rock;
        }

        function createFlower(x, y, z) {
            const flower = new THREE.Group();
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.4), new THREE.MeshStandardMaterial({color: 0x2d6a4f, roughness: 1}));
            stem.position.y = 0.2;
            const colors = [0xff99c2, 0xffd166, 0xef476f, 0x118ab2, 0xffffff]; 
            const petalColor = colors[Math.floor(Math.random() * colors.length)];
            const petal = new THREE.Mesh(new THREE.DodecahedronGeometry(0.2), new THREE.MeshStandardMaterial({color: petalColor, flatShading: true, roughness: 1}));
            petal.position.y = 0.4;
            flower.add(stem, petal); flower.position.set(x, y, z);
            return flower;
        }

        // --- 2. ‡∏û‡∏∑‡πâ‡∏ô‡∏ú‡∏¥‡∏ß‡∏ó‡∏∞‡πÄ‡∏• ---
        const seaGeo = new THREE.BoxGeometry(40, 2, 100, 12, 1, 30);
        const seaPos = seaGeo.attributes.position;
        for (let i = 0; i < seaPos.count; i++) {
            if (seaPos.getY(i) > 0) seaPos.setY(i, 1 + Math.random() * 0.6);
        }
        seaGeo.computeVertexNormals();
        const waterMat = new THREE.MeshPhysicalMaterial({ color: 0x0077be, metalness: 0.1, roughness: 0.1, transmission: 0.5, transparent: true, flatShading: true });
        const sea = new THREE.Mesh(seaGeo, waterMat);
        sea.position.set(-30, 0, 0); 
        sea.userData = { type: '‡∏ó‡∏∞‡πÄ‡∏•‡∏ô‡πâ‡∏≥‡∏•‡∏∂‡∏Å', speed: 0.20, power: 12, desc: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á ‡∏•‡∏°‡πÅ‡∏£‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î' };
        scene.add(sea); terrains.push(sea);

        // --- 3. ‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á ---
        const coastGeo = new THREE.BoxGeometry(20, 2.5, 100, 6, 1, 25);
        const coastPos = coastGeo.attributes.position;
        for(let i=0; i<coastPos.count; i++){
            if(coastPos.getY(i) > 0) {
                const x = coastPos.getX(i); const z = coastPos.getZ(i);
                coastPos.setY(i, 1.25 + Math.sin(x*0.6)*0.3 + Math.cos(z*0.4)*0.4 + (Math.random()*0.2));
            }
        }
        coastGeo.computeVertexNormals();
        const coast = new THREE.Mesh(coastGeo, new THREE.MeshStandardMaterial({ color: 0xe9c46a, roughness: 1, flatShading: true }));
        coast.position.set(0, 0, 0); coast.receiveShadow = true;
        coast.userData = { type: '‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏∞‡πÄ‡∏•', speed: 0.12, power: 8, desc: '‡∏•‡∏°‡∏û‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å' };
        scene.add(coast); terrains.push(coast);
        for(let i=0; i<35; i++) { scene.add(createRock(Math.random()*16 - 8, 1.2, Math.random()*90 - 45, 0.3 + Math.random()*0.5)); }

        // --- 4. ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡πà‡∏≤‡πÑ‡∏°‡πâ ---
        const plainGeo = new THREE.BoxGeometry(40, 3, 50, 10, 1, 12);
        const plainPos = plainGeo.attributes.position;
        for(let i=0; i<plainPos.count; i++){
            if(plainPos.getY(i) > 0) {
                const x = plainPos.getX(i); const z = plainPos.getZ(i);
                plainPos.setY(i, 1.5 + Math.sin(x*0.4)*0.6 + Math.cos(z*0.3)*0.5);
            }
        }
        plainGeo.computeVertexNormals();
        const plain = new THREE.Mesh(plainGeo, new THREE.MeshStandardMaterial({ color: 0x90be6d, roughness: 1, flatShading: true }));
        plain.position.set(30, 0, 25); plain.receiveShadow = true;
        plain.userData = { type: '‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ö‡πÇ‡∏•‡πà‡∏á', speed: 0.08, power: 5, desc: '‡∏•‡∏°‡∏û‡∏±‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' };
        scene.add(plain); terrains.push(plain);

        const forestGeo = new THREE.BoxGeometry(40, 3.2, 50, 8, 1, 10);
        const forestPos = forestGeo.attributes.position;
        for(let i=0; i<forestPos.count; i++) { if(forestPos.getY(i) > 0) forestPos.setY(i, 1.6 + Math.random()*0.4); }
        forestGeo.computeVertexNormals();
        const forest = new THREE.Mesh(forestGeo, new THREE.MeshStandardMaterial({ color: 0x43aa8b, roughness: 1, flatShading: true }));
        forest.position.set(30, 0, -25); forest.receiveShadow = true;
        forest.userData = { type: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤‡πÑ‡∏°‡πâ', speed: 0.03, power: 2, desc: '‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏ö‡∏±‡∏á‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏° ‡∏•‡∏°‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å' };
        scene.add(forest); terrains.push(forest);

        for(let i=0; i<80; i++) { 
            let tx = 12 + Math.random() * 36; let tz = -48 + Math.random() * 46;
            scene.add(createTree(tx, 1.6, tz, 0.4 + Math.random() * 0.6)); 
        }
        for(let i=0; i<25; i++) { 
            let tx = 12 + Math.random() * 36; let tz = 2 + Math.random() * 46;
            let ty = 1.5 + Math.sin((tx-30)*0.4)*0.6 + Math.cos((tz-25)*0.3)*0.5;
            scene.add(createTree(tx, ty, tz, 0.3 + Math.random() * 0.4)); 
        }
        for(let i=0; i<30; i++) { 
            let bx = 12 + Math.random() * 36; let bz = 2 + Math.random() * 46;
            let by = 1.5 + Math.sin((bx-30)*0.4)*0.6 + Math.cos((bz-25)*0.3)*0.5;
            scene.add(createBush(bx, by, bz, 0.5 + Math.random() * 0.5)); 
        }
        for(let i=0; i<50; i++) { 
            let fx = 12 + Math.random() * 36; let fz = 2 + Math.random() * 46;
            let fy = 1.5 + Math.sin((fx-30)*0.4)*0.6 + Math.cos((fz-25)*0.3)*0.5;
            scene.add(createFlower(fx, fy, fz)); 
        }

        // --- 5. ‡πÄ‡∏ó‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏≤ ---
        const mountainGroup = new THREE.Group();
        const mtxMat = new THREE.MeshStandardMaterial({ color: 0x556b2f, flatShading: true, roughness: 1 });
        const snowMat = new THREE.MeshStandardMaterial({ color: 0xfffafa, flatShading: true, roughness: 1 });
        const mountData = { type: '‡∏¢‡∏≠‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤', speed: 0.16, power: 10, desc: '‡∏¢‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡∏û‡πâ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á ‡∏•‡∏°‡∏¢‡∏¥‡πà‡∏á‡∏û‡∏±‡∏î‡πÅ‡∏£‡∏á' };

        const m1 = new THREE.Mesh(new THREE.ConeGeometry(14, 26, 7), mtxMat); 
        m1.position.set(0, 13, 0); m1.castShadow = true; m1.receiveShadow = true; m1.userData = mountData; 
        const s1 = new THREE.Mesh(new THREE.ConeGeometry(5, 8, 7), snowMat); s1.position.set(0, 22, 0);
        
        const m2 = new THREE.Mesh(new THREE.ConeGeometry(9, 15, 6), mtxMat); 
        m2.position.set(-8, 7.5, 5); m2.castShadow = true; m2.receiveShadow = true; m2.userData = mountData;
        const s2 = new THREE.Mesh(new THREE.ConeGeometry(3, 4.5, 6), snowMat); s2.position.set(-8, 12.5, 5);
        
        const m3 = new THREE.Mesh(new THREE.ConeGeometry(11, 18, 6), mtxMat); 
        m3.position.set(8, 9, -5); m3.castShadow = true; m3.receiveShadow = true; m3.userData = mountData;
        const s3 = new THREE.Mesh(new THREE.ConeGeometry(3.5, 6, 6), snowMat); s3.position.set(8, 15, -5);
        
        mountainGroup.add(m1, s1, m2, s2, m3, s3);
        mountainGroup.position.set(25, 1.5, -10);
        scene.add(mountainGroup); terrains.push(m1, m2, m3);

// --- 6. ‚òÅÔ∏è ‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏°‡∏Ü‡∏ü‡∏π‡∏ô‡∏∏‡πà‡∏° (‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏á Icosahedron) ---
        const clouds = [];
        function createCloud() {
            const cloudGroup = new THREE.Group();
            const cloudMat = new THREE.MeshStandardMaterial({ color: 0xffffff, flatShading: true, roughness: 1 });
            // ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏á 20 ‡∏´‡∏ô‡πâ‡∏≤ (Icosahedron) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ü‡∏π‡πÅ‡∏•‡∏∞‡∏°‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            const geo = new THREE.IcosahedronGeometry(1, 0); 
            const puffs = 5 + Math.floor(Math.random() * 4); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏¢‡πà‡∏≠‡∏¢
            for(let i=0; i<puffs; i++) {
                const puff = new THREE.Mesh(geo, cloudMat);
                // ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
                puff.position.set((Math.random()-0.5)*10, (Math.random()-0.5)*4, (Math.random()-0.5)*6);
                const scale = 1.5 + Math.random() * 2.5;
                puff.scale.set(scale, scale, scale);
                // ‡∏´‡∏°‡∏∏‡∏ô‡∏°‡∏±‡πà‡∏ß‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                puff.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
                cloudGroup.add(puff);
            }
            return cloudGroup;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏Ü 12 ‡∏Å‡πâ‡∏≠‡∏ô ‡∏•‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏ü‡πâ‡∏≤
        for(let i=0; i<12; i++) {
            const c = createCloud();
            c.position.set(-80 + Math.random() * 160, 25 + Math.random() * 20, -60 + Math.random() * 120);
            c.userData = { speed: 0.01 + Math.random() * 0.03 }; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°
            scene.add(c); 
            clouds.push(c);
        }

// ========================================================
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏•‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á ---
        // ========================================================
        const turbines = []; const turbineHitboxes = [];

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 3.1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î 3D ‡∏≠‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
        function calculateRealPower(x, y, z, type) {
            let power = 0;
            if (type === '‡∏¢‡∏≠‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤') {
                // ‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á(Y) ‡∏¢‡∏¥‡πà‡∏á‡∏•‡∏°‡πÅ‡∏£‡∏á‡∏û‡πâ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á (‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 18-20 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)
                power = 5 + (y * 0.6); 
            } else if (type === '‡∏ó‡∏∞‡πÄ‡∏•‡∏ô‡πâ‡∏≥‡∏•‡∏∂‡∏Å') {
                // ‡∏¢‡∏¥‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏´‡πà‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á (X ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö‡∏°‡∏≤‡∏Å‡πÜ) ‡∏•‡∏°‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ (‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 15-18 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)
                power = 10 + (Math.abs(x) * 0.15);
            } else if (type === '‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏∞‡πÄ‡∏•') {
                // ‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏π‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ ‡∏£‡∏±‡∏ö‡∏•‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥
                power = 6 + (y * 2);
            } else if (type === '‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ö‡πÇ‡∏•‡πà‡∏á') {
                // ‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô‡∏´‡∏ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏î‡πâ‡∏•‡∏°‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤
                power = 3 + ((y - 1.0) * 3.5);
            } else if (type === '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πà‡∏≤‡πÑ‡∏°‡πâ') {
                // ‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ö‡∏±‡∏á‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏° ‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô
                power = 1 + (y * 0.5);
            }
            return Math.round(power); // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 3.2: ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
        function getDynamicDesc(power, type) {
            if (type === '‡∏¢‡∏≠‡∏î‡∏†‡∏π‡πÄ‡∏Ç‡∏≤') {
                return power > 15 ? "‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤‡∏™‡∏π‡∏á‡∏ä‡∏±‡∏ô ‡∏•‡∏°‡∏û‡∏±‡∏î‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÑ‡∏£‡πâ‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á!" : "‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ï‡∏µ‡∏ô‡πÄ‡∏Ç‡∏≤ ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏á‡∏•‡∏°‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô";
            } else if (type === '‡∏ó‡∏∞‡πÄ‡∏•‡∏ô‡πâ‡∏≥‡∏•‡∏∂‡∏Å') {
                return power > 14 ? "‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•‡∏•‡∏∂‡∏Å ‡∏•‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏£‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏±‡πâ‡∏ô" : "‡∏ó‡∏∞‡πÄ‡∏•‡πÉ‡∏Å‡∏•‡πâ‡∏ù‡∏±‡πà‡∏á ‡∏•‡∏°‡πÅ‡∏£‡∏á‡∏î‡∏µ‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏•‡∏°‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏á";
            } else if (type === '‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ö‡πÇ‡∏•‡πà‡∏á') {
                return power >= 7 ? "‡πÄ‡∏ô‡∏¥‡∏ô‡∏´‡∏ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏•‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥" : "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≥ ‡∏•‡∏°‡∏û‡∏±‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
            } else if (type === '‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏∞‡πÄ‡∏•') {
                return power >= 9 ? "‡πÄ‡∏ô‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á ‡∏£‡∏±‡∏ö‡∏•‡∏°‡∏ó‡∏∞‡πÄ‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÜ" : "‡∏£‡∏¥‡∏°‡∏´‡∏≤‡∏î‡∏ï‡πà‡∏≥ ‡∏•‡∏°‡∏î‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏£‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ö‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô";
            } else {
                return "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏ß‡∏≤‡∏á‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏° ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏î‡πâ‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å";
            }
        }

        function createTurbine(x, y, z, data, actualPower) {
            const turbineGroup = new THREE.Group();
            const tower = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.8, 12, 16), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            tower.position.y = 6; turbineGroup.add(tower);
            const nacelle = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 3), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            nacelle.position.set(0, 12, 0.5); turbineGroup.add(nacelle);
            const rotorGroup = new THREE.Group(); rotorGroup.position.set(0, 12, 2);
            for (let i = 0; i < 3; i++) {
                const blade = new THREE.Mesh(new THREE.BoxGeometry(0.2, 9, 0.5), new THREE.MeshStandardMaterial({ color: 0xdddddd }));
                blade.position.y = 4.5; const pivot = new THREE.Group();
                pivot.rotation.z = (i * 120) * (Math.PI / 180); pivot.add(blade); rotorGroup.add(pivot);
            }
            turbineGroup.add(rotorGroup); turbineGroup.position.set(x, y, z);
            const hitbox = new THREE.Mesh(new THREE.CylinderGeometry(2.5, 2.5, 18), new THREE.MeshBasicMaterial({ visible: false }));
            hitbox.position.y = 9; 
            
            // ‡∏ù‡∏±‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πä‡∏∞‡πÜ
            hitbox.userData = { isTurbine: true, group: turbineGroup, power: actualPower };
            turbineGroup.add(hitbox); scene.add(turbineGroup);
            
            // ‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏°‡πÅ‡∏£‡∏á ‡∏à‡∏∞‡πÉ‡∏ö‡∏û‡∏±‡∏î‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤!
            const rotationSpeed = actualPower * 0.012; 
            turbines.push({ group: turbineGroup, rotor: rotorGroup, speed: rotationSpeed });
            turbineHitboxes.push(hitbox);
        }

        function isTooClose(x, y, z) {
            for (let t of turbines) {
                const p = t.group.position;
                if (Math.sqrt(Math.pow(p.x - x, 2) + Math.pow(p.y - y, 2) + Math.pow(p.z - z, 2)) < MIN_DISTANCE) return true;
            } return false;
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö Interaction ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ñ‡∏•‡∏¥‡∏Å ---
        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
        window.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' || !isGameActive) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏ö‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            const hitTurbines = raycaster.intersectObjects(turbineHitboxes);
            if (hitTurbines.length > 0) {
                const hit = hitTurbines[0].object; scene.remove(hit.userData.group);
                currentEnergyRate -= hit.userData.power; turbinesPlaced--;
                turbines.splice(turbines.findIndex(t => t.group === hit.userData.group), 1);
                turbineHitboxes.splice(turbineHitboxes.indexOf(hit), 1);
                document.getElementById('turbines-left').innerText = maxTurbines - turbinesPlaced;
                document.getElementById('energy-rate').innerText = currentEnergyRate;
                if(turbinesPlaced < maxTurbines) document.getElementById('submit-btn-container').style.display = 'none';
                return;
            }

            if (turbinesPlaced >= maxTurbines) return;
            const intersects = raycaster.intersectObjects(terrains);
            if (intersects.length > 0) {
                const hit = intersects[0];
                if (buildMode === "cluster") {
                    // ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏á 3 ‡∏ï‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                    const offsets = [{x: 0, z: 0}, {x: -10, z: -10}, {x: 10, z: -10}]; 
                    let placedInCluster = false; let totalClusterPower = 0;
                    for (let off of offsets) {
                        if (turbinesPlaced >= maxTurbines) break;
                        let px = hit.point.x + off.x; let pz = hit.point.z + off.z;
                        let rayDown = new THREE.Raycaster(new THREE.Vector3(px, 100, pz), new THREE.Vector3(0, -1, 0));
                        let groundHits = rayDown.intersectObjects(terrains);
                        if (groundHits.length > 0) {
                            let gHit = groundHits[0]; if (isTooClose(gHit.point.x, gHit.point.y, gHit.point.z)) continue;
                            
                            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏ö
                            let actualPower = calculateRealPower(gHit.point.x, gHit.point.y, gHit.point.z, gHit.object.userData.type);
                            createTurbine(gHit.point.x, gHit.point.y, gHit.point.z, gHit.object.userData, actualPower);
                            
                            turbinesPlaced++; currentEnergyRate += actualPower; totalClusterPower += actualPower;
                            placedInCluster = true;
                        }
                    }
                    if (placedInCluster) {
                        document.getElementById('knowledge-box').style.display = 'block'; document.getElementById('k-title').innerText = "‡∏ß‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° 3 ‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                        document.getElementById('k-desc').innerText = "‡∏ß‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏Å‡∏•‡∏°‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ç‡∏∂‡πâ‡∏ô"; document.getElementById('k-power').innerText = `+${totalClusterPower}`;
                    } else showWarning("‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ!");
                } else {
                    // ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡πâ‡∏ô
                    const data = hit.object.userData;
                    if (isTooClose(hit.point.x, hit.point.y, hit.point.z)) { showWarning("‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏•‡∏°‡∏à‡∏∞‡∏Å‡∏ß‡∏ô‡∏Å‡∏±‡∏ô!"); return; }
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î 3D ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏ô
                    let actualPower = calculateRealPower(hit.point.x, hit.point.y, hit.point.z, data.type);
                    let dynamicDesc = getDynamicDesc(actualPower, data.type);

                    createTurbine(hit.point.x, hit.point.y, hit.point.z, data, actualPower);
                    
                    turbinesPlaced++; currentEnergyRate += actualPower;
                    document.getElementById('knowledge-box').style.display = 'block'; document.getElementById('k-title').innerText = data.type;
                    document.getElementById('k-desc').innerText = dynamicDesc;
                    document.getElementById('k-power').innerText = `+${actualPower}`;
                }
                document.getElementById('turbines-left').innerText = maxTurbines - turbinesPlaced; document.getElementById('energy-rate').innerText = currentEnergyRate;
                if (turbinesPlaced === maxTurbines) document.getElementById('submit-btn-container').style.display = 'block';
            }
        });

        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
        });

        // --- 9. ‡∏£‡∏∞‡∏ö‡∏ö Animation Loop (‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏°‡∏Ü) ---
        function animate() {
            requestAnimationFrame(animate);
            
            // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÉ‡∏ö‡∏û‡∏±‡∏î‡∏Å‡∏±‡∏á‡∏´‡∏±‡∏ô
            turbines.forEach(t => t.rotor.rotation.z -= t.speed);
            
            // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏°‡∏Ü‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏•‡∏°
            clouds.forEach(c => {
                c.position.x += c.userData.speed;
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏Ü‡∏•‡∏≠‡∏¢‡πÄ‡∏•‡∏¢‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏ú‡∏•‡πà‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
                if(c.position.x > 80) {
                    c.position.x = -80;
                    c.position.z = -60 + Math.random() * 120; // ‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏Å‡∏ô‡∏•‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
                }
            });

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
       
        